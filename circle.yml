machine:
  php:
    version: 5.5.21
  ruby:
    version: 2.1.3
  environment:
    APP_ENV: testing

general:
  artifacts:
    - "tests/codeception/_output"
    - "storage/logs"

dependencies:
  cache_directories:
    - elasticsearch-1.6.0
    - node_modules
    - public/components
    - vendor
  pre:
    - pecl install xdebug
    - echo "memory_limit = 1024M" > ~/.phpenv/versions/5.5.21/etc/conf.d/memory.ini
    - if [[ ! -e elasticsearch-1.6.0 ]]; then wget https://download.elastic.co/elasticsearch/elasticsearch/elasticsearch-1.6.0.tar.gz && tar -xvf elasticsearch-1.6.0.tar.gz; fi
    - elasticsearch-1.6.0/bin/elasticsearch: {background: true}
  override:
    - bundle install
    - npm install
    - composer install --prefer-source --no-interaction
    - node_modules/.bin/bower install
    # - php artisan serve: {background: true}
    # - phantomjs --webdriver="4444" --ignore-ssl-errors="true": {background: true}

database:
  post:
    - php artisan migrate --seed -vvv
    - mysqldump -u ubuntu circle_test > tests/codeception/_data/dump.sql

test:
  pre:
    - mkdir -p $CIRCLE_TEST_REPORTS/phpspec
  override:
    - php artisan twig:lint
    - node_modules/.bin/grunt rebuild
    - node_modules/.bin/grunt lint
    - vendor/bin/codecept run -vvv --no-interaction --debug --xml="$CIRCLE_TEST_REPORTS/codeception/project.xml"
    - vendor/bin/phpspec run -vvv --no-interaction --format="pretty"
    - vendor/bin/phpspec run -vvv --no-interaction --format="junit" > $CIRCLE_TEST_REPORTS/phpspec/project.xml # This one is just for CircleCI